<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>客戶維護管理（v4.2 明亮版）</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --line:#e6e8f0;
      --text:#1e2430;
      --muted:#606a7a;
      --accent:#2d6cdf;

      --good:#17b26a;
      --warn:#f79009;
      --bad:#f04438;
      --neutral:#98a2b3;

      --radius:14px;
      --shadow: 0 10px 22px rgba(16,24,40,.08);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header{
      max-width: 1200px;
      margin: 18px auto 10px;
      padding: 0 18px;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
    }
    .title h1{margin:0;font-size:18px;letter-spacing:.2px}
    .title p{margin:6px 0 0;color:var(--muted);font-size:12.5px;line-height:1.4}

    main{max-width:1200px;margin:0 auto;padding:0 18px 24px;}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background: #fff;
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
      transition:.15s transform ease, .15s box-shadow ease;
      box-shadow: 0 6px 14px rgba(16,24,40,.06);
      user-select:none;
      text-decoration:none;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{transform: translateY(-1px); box-shadow: 0 10px 20px rgba(16,24,40,.08);}
    .btn:active{transform: translateY(0px);}

    .btn.primary{
      border-color: rgba(45,108,223,.25);
      background: rgba(45,108,223,.10);
      color: #1849a9;
    }
    .btn.danger{
      border-color: rgba(240,68,56,.25);
      background: rgba(240,68,56,.08);
      color: #b42318;
    }

    .seg{
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
      display:inline-flex;
      background:#fff;
      box-shadow: 0 6px 14px rgba(16,24,40,.06);
    }
    .seg button{
      border:0;
      background: transparent;
      color: var(--muted);
      padding:10px 12px;
      cursor:pointer;
      font-weight:700;
    }
    .seg button.active{
      background: rgba(45,108,223,.10);
      color: #1849a9;
    }

    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .card .hd h2{margin:0;font-size:14px}
    .card .bd{padding:14px}

    input[type="text"], input[type="date"], input[type="month"], select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background: #fff;
      color: var(--text);
      outline:none;
    }
    textarea{min-height:90px;resize:vertical}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family: var(--mono);}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
    }
    thead th{
      text-align:left;
      font-size:12px;
      color: var(--muted);
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      background: #fbfbfe;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      vertical-align:top;
    }
    tbody tr:hover{background: #fbfdff;}
    tbody tr:last-child td{border-bottom:none}

    .status{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .dot.good{background: var(--good)}
    .dot.warn{background: var(--warn)}
    .dot.bad{background: var(--bad)}
    .dot.neutral{background: var(--neutral)}

    .months{display:flex; flex-wrap:wrap; gap:6px;}
    .mchip{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      user-select:none;
      white-space:nowrap;
    }
    .mchip .d{width:8px;height:8px;border-radius:999px;background: var(--neutral);}
    .mchip.done{border-color: rgba(23,178,106,.25); background: rgba(23,178,106,.07);}
    .mchip.done .d{background: var(--good)}
    .mchip.todo{border-color: rgba(247,144,9,.25); background: rgba(247,144,9,.07);}
    .mchip.todo .d{background: var(--warn)}
    .mchip.selected{outline: 2px solid rgba(45,108,223,.20);}

    .link{color: var(--accent); text-decoration: underline; cursor:pointer}
    .divider{height:1px;background:var(--line);margin:12px 0}

    .modal{position:fixed; inset:0; background: rgba(16,24,40,.45); display:none; align-items:center; justify-content:center; padding:18px; z-index:99;}
    .modal .box{width:min(560px, 100%); border:1px solid var(--line); border-radius:16px; background:#fff; box-shadow: var(--shadow); overflow:hidden;}
    .modal .box .hd{padding:12px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px; border-bottom:1px solid var(--line); background:#fbfbfe;}
    .modal .box .bd{padding:14px}
    .grid{display:grid; gap:10px}
    .grid.two{grid-template-columns: 1fr 1fr}
    @media (max-width: 980px){ .grid.two{grid-template-columns: 1fr} }

    #routeEdit{margin-top:14px;}
    #calendarWrap{display:none;}

    /* calendar */
    .cal{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }
    .calHead{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      background:#fbfbfe;
      border-bottom:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
    }
    .calHead div{padding:10px 10px; border-right:1px solid var(--line);}
    .calHead div:last-child{border-right:none;}
    .calGrid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
    }
    .dayCell{
      min-height:110px;
      border-right:1px solid var(--line);
      border-bottom:1px solid var(--line);
      padding:8px;
    }
    .dayCell:nth-child(7n){border-right:none;}
    .dayNum{
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-bottom:6px;
    }
    .pill{
      font-size:11px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:2px 8px;
      color:var(--muted);
      background:#fff;
      white-space:nowrap;
    }
    .task{
      display:flex;
      align-items:flex-start;
      gap:6px;
      border:1px solid var(--line);
      border-radius:12px;
      padding:6px 8px;
      margin-top:6px;
      cursor:pointer;
      background:#fff;
    }
    .task:hover{background:#fbfdff;}
    .taskTitle{
      font-size:12px;
      font-weight:750;
      line-height:1.25;
    }
    .taskSub{
      font-size:11px;
      color:var(--muted);
      line-height:1.25;
      margin-top:2px;
    }
  </style>
</head>

<body>
<header>
  <div class="title">
    <h1>客戶維護管理（v4.2 明亮版）</h1>
    <p>管理端：新增/編輯維護排程。工程師端：可選「清單 / 行事曆」檢視，直接設定完工。</p>
  </div>

  <div class="row">
    <div class="seg" id="modeSeg" title="切換使用情境">
      <button type="button" data-mode="admin" class="active">管理端</button>
      <button type="button" data-mode="eng">工程師端</button>
    </div>

    <div class="seg" id="viewSeg" title="工程師端檢視模式" style="display:none;">
      <button type="button" data-view="list" class="active">清單</button>
      <button type="button" data-view="cal">行事曆</button>
    </div>

    <button class="btn primary" id="btnNew" type="button">＋ 新增維護</button>
    <button class="btn" id="btnExport" type="button">匯出 JSON</button>
    <button class="btn" id="btnImport" type="button">匯入 JSON</button>
    <button class="btn danger" id="btnClear" type="button">清除資料</button>
  </div>
</header>

<main>
  <!-- HOME -->
  <section id="routeHome" class="card">
    <div class="hd">
      <h2 id="homeTitle">維護清單</h2>
      <div class="row" style="min-width: 680px; max-width: 980px;">
        <input type="text" id="q" placeholder="搜尋：客戶 / 產品…" style="flex:1; min-width:220px" />
        <input type="month" id="monthPick" style="width:180px" />
        <select id="scope" style="width:210px">
          <option value="all">顯示：全部客戶</option>
          <option value="need">顯示：僅本月需維護</option>
          <option value="none">顯示：僅本月無維護</option>
        </select>
        <select id="doneFilter" style="width:170px">
          <option value="all">狀態：全部</option>
          <option value="todo">狀態：本月未完工</option>
          <option value="done">狀態：本月已完工</option>
        </select>
      </div>
    </div>

    <div class="bd">
      <!-- List -->
      <div id="listWrap">
        <div style="max-height: 600px; overflow:auto; border-radius:14px;">
          <table>
            <thead>
              <tr>
                <th style="width:220px">客戶名稱</th>
                <th style="width:160px">產品名稱</th>
                <th style="width:240px">維護期間</th>
                <th>預定維護月份</th>
                <th style="width:170px">維護狀態（本月）</th>
                <th style="width:220px">操作（本月）</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>

      <!-- Calendar -->
      <div id="calendarWrap">
        <div class="cal">
          <div class="calHead">
            <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
          </div>
          <div class="calGrid" id="calGrid"></div>
        </div>
        <div class="small" style="margin-top:10px;">
          行事曆以「本月維護到期日（每個維護月份的最後一天）」顯示；點選任務可直接設定完工。
        </div>
      </div>

      <div class="divider"></div>
      <div class="small" id="homeHint"></div>
    </div>
  </section>

  <!-- EDIT -->
  <section id="routeEdit" class="card">
    <div class="hd">
      <h2 id="editTitle">新增/編輯維護</h2>
      <div class="row">
        <button class="btn" id="btnBack" type="button">← 回清單</button>
      </div>
    </div>

    <div class="bd">
      <form id="formEdit">
        <div class="grid two">
          <div>
            <label>客戶名稱</label>
            <input type="text" id="customer" required placeholder="例如：OO科技大學 / 鴻洋遊艇 / 台灣大福…" />
          </div>
          <div>
            <label>產品名稱（可下拉快速選擇，也可自行輸入）</label>
            <input type="text" id="product" list="productList" required placeholder="例如：ee-class / km+ / tms+ / Adobe Connect" />
            <datalist id="productList">
              <option value="ee-class"></option>
              <option value="km+"></option>
              <option value="tms+"></option>
              <option value="Adobe Connect"></option>
            </datalist>
          </div>
        </div>

        <div class="grid two" style="margin-top:10px">
          <div>
            <label>維護起日（自動推算迄日：+1年-1天，可修改）</label>
            <input type="date" id="startDate" required />
          </div>
          <div>
            <label>維護迄日</label>
            <input type="date" id="endDate" required />
          </div>
        </div>

        <div style="margin-top:10px">
          <label>預定維護月份（先自動產生：起日 +2、每 +3；可手動增減）</label>
          <div class="row" style="align-items:flex-end">
            <div style="width:200px">
              <label class="small" style="margin:0 0 6px">加入月份（YYYY-MM）</label>
              <input type="month" id="addYM" />
            </div>
            <button type="button" class="btn" id="btnAddYM">加入月份</button>
            <button type="button" class="btn" id="btnResetAuto">重置為自動排程</button>
            <span class="small">移除：點月份 ×</span>
          </div>
          <div class="months" id="ymChips" style="margin-top:10px"></div>
          <div class="small" id="schedulePreview" style="margin-top:8px"></div>
        </div>

        <div style="margin-top:10px">
          <label>備註（選填）</label>
          <textarea id="notes" placeholder="例如：每季例行資安檢測 / 版本更新 / 備份演練 / 遠端窗口…"></textarea>
        </div>

        <div class="divider"></div>

        <div class="row" style="justify-content:space-between">
          <div class="small">提示：修改起迄日會重新計算自動月份；如需例外維護，可再手動加入月份。</div>
          <div class="row">
            <button type="button" class="btn danger" id="btnDelete" style="display:none">刪除此維護</button>
            <button type="button" class="btn" id="btnCancel">取消</button>
            <button type="submit" class="btn primary">儲存</button>
          </div>
        </div>
      </form>
    </div>
  </section>
</main>

<!-- 完工 Modal -->
<div class="modal" id="doneModal">
  <div class="box">
    <div class="hd">
      <div>
        <div style="font-weight:800">設定完工</div>
        <div class="small" id="mSub"></div>
      </div>
      <button class="btn" id="mClose" type="button">關閉</button>
    </div>
    <div class="bd">
      <div class="grid two">
        <div>
          <label>完工日期</label>
          <input type="date" id="mDoneDate" />
        </div>
        <div style="display:flex; align-items:end;">
          <label class="status" style="margin:0">
            <span class="dot good"></span>
            <input type="checkbox" id="mIsDone" />
            已完工
          </label>
        </div>
      </div>
      <div class="divider"></div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn primary" id="mSave" type="button">儲存</button>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // 1. 請在此處填入您從 Google Apps Script 部署後取得的網址
  const API_URL = "https://script.google.com/macros/s/AKfycbyXxKaz0xOLOML0mjze0GOKGTo2FA3iX1O3p-HTKhM/dev";

  /** Helpers **/
  const todayISO = () => new Date().toISOString().slice(0,10);
  const parseISO = (s) => s ? new Date(s + "T00:00:00") : null;
  const fmtYMD = (d) => {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd= String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  };
  const addYearsMinus1Day = (startISO) => {
    const d = parseISO(startISO);
    if(!d) return "";
    const next = new Date(d.getFullYear()+1, d.getMonth(), d.getDate());
    const end  = new Date(next.getTime() - 86400000);
    return fmtYMD(end);
  };
  const addMonths = (date, months) => {
    const d = new Date(date.getFullYear(), date.getMonth(), 1);
    d.setMonth(d.getMonth() + months);
    return d;
  };
  const ymOf = (date) => `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,"0")}`;
  const lastDayOfYM = (ymStr) => {
    const [y,m] = ymStr.split("-").map(Number);
    return new Date(y, m, 0);
  };
  const esc = (s) => String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");

  /** Cloud Storage (Modified) **/
  let records = [];

  // 替換原本的 load：改為從 Google Sheets 讀取
  async function load(){
    try {
      const resp = await fetch(API_URL);
      const data = await resp.json();
      records = Array.isArray(data) ? data : [];
      renderHome(); // 讀取完畢後渲染畫面
    } catch(e) {
      console.error("讀取雲端資料失敗:", e);
      records = [];
    }
  }

  // 替換原本的 save：改為傳送到 Google Sheets
  async function save(){
    try {
      await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(records)
      });
      console.log("資料已同步到雲端");
    } catch(e) {
      alert("同步雲端失敗，請檢查網路連線");
    }
  }

  const newId = () => "M" + Date.now().toString(36) + Math.random().toString(36).slice(2,7);

  /** Schedule Logic **/
  function buildAutoYMList(startISO, endISO){
    const s = parseISO(startISO), e = parseISO(endISO);
    if(!s || !e || e < s) return [];
    const startMonth0 = new Date(s.getFullYear(), s.getMonth(), 1);
    let cur = addMonths(startMonth0, 2);
    const endMonth0 = new Date(e.getFullYear(), e.getMonth(), 1);
    const out = [];
    while(cur <= endMonth0){
      out.push(ymOf(cur));
      cur = addMonths(cur, 3);
    }
    return out;
  }
  function normalizeScheduleFromYMList(ymList, keepDoneMap){
    const uniq = Array.from(new Set((ymList||[]).filter(Boolean))).sort();
    return uniq.map(ymStr => {
      const prev = keepDoneMap.get(ymStr);
      return {
        ym: ymStr,
        dueDate: fmtYMD(lastDayOfYM(ymStr)),
        isDone: prev ? !!prev.isDone : false,
        doneDate: prev ? (prev.doneDate || "") : ""
      };
    });
  }
  function findSchedule(rec, ymStr){
    return (rec.schedule || []).find(s => s.ym === ymStr) || null;
  }

  /** UI refs **/
  const routeHome = document.getElementById("routeHome");
  const routeEdit = document.getElementById("routeEdit");
  const modeSeg = document.getElementById("modeSeg");
  const viewSeg = document.getElementById("viewSeg");
  const btnNew = document.getElementById("btnNew");
  const btnExport = document.getElementById("btnExport");
  const btnImport = document.getElementById("btnImport");
  const btnClear  = document.getElementById("btnClear");
  const homeTitle = document.getElementById("homeTitle");
  const homeHint = document.getElementById("homeHint");
  const qEl = document.getElementById("q");
  const monthPick = document.getElementById("monthPick");
  const scope = document.getElementById("scope");
  const doneFilter = document.getElementById("doneFilter");
  const rowsEl = document.getElementById("rows");
  const listWrap = document.getElementById("listWrap");
  const calendarWrap = document.getElementById("calendarWrap");
  const calGrid = document.getElementById("calGrid");

  // edit refs
  const editTitle = document.getElementById("editTitle");
  const btnBack = document.getElementById("btnBack");
  const formEdit = document.getElementById("formEdit");
  const customerEl = document.getElementById("customer");
  const productEl = document.getElementById("product");
  const startEl = document.getElementById("startDate");
  const endEl = document.getElementById("endDate");
  const notesEl = document.getElementById("notes");
  const btnDelete = document.getElementById("btnDelete");
  const btnCancel = document.getElementById("btnCancel");
  const addYM = document.getElementById("addYM");
  const btnAddYM = document.getElementById("btnAddYM");
  const btnResetAuto = document.getElementById("btnResetAuto");
  const ymChips = document.getElementById("ymChips");
  const schedulePreview = document.getElementById("schedulePreview");

  // modal refs
  const doneModal = document.getElementById("doneModal");
  const mSub = document.getElementById("mSub");
  const mClose = document.getElementById("mClose");
  const mDoneDate = document.getElementById("mDoneDate");
  const mIsDone = document.getElementById("mIsDone");
  const mSave = document.getElementById("mSave");

  /** State **/
  let mode = "admin";
  let engView = "list";
  let editingId = null;
  let editingYMList = [];
  let modalCtx = null;

  function curYM(){
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
  }
  if(!monthPick.value) monthPick.value = curYM();

  /** Routing **/
  window.addEventListener("hashchange", router);
  function nav(hash){
    if(location.hash !== hash) location.hash = hash;
    router();
  }
  function showHome(){
    routeHome.style.display = "block";
    routeEdit.style.display = "none";
  }
  function showEdit(){
    routeHome.style.display = "none";
    routeEdit.style.display = "block";
  }
  function router(){
    const h = location.hash || "#/";
    const [path, qs] = h.split("?");
    const params = new URLSearchParams(qs || "");

    if(path === "#/" || path === ""){
      showHome();
      renderHome();
      return;
    }
    if(path === "#/new"){
      if(mode !== "admin"){ nav("#/"); return; }
      showEdit();
      openEditor(null);
      return;
    }
    if(path === "#/edit"){
      if(mode !== "admin"){ nav("#/"); return; }
      showEdit();
      openEditor(params.get("id"));
      return;
    }
  }

  /** Mode & View Switching **/
  modeSeg.addEventListener("click", (e) => {
    const b = e.target.closest("button[data-mode]");
    if(!b) return;
    mode = b.dataset.mode;
    Array.from(modeSeg.querySelectorAll("button")).forEach(x => x.classList.toggle("active", x === b));
    if(mode === "eng"){
      scope.value = "need"; doneFilter.value = "todo";
      btnNew.style.display = "none"; viewSeg.style.display = "inline-flex";
    } else {
      scope.value = "all"; doneFilter.value = "all";
      btnNew.style.display = ""; viewSeg.style.display = "none";
    }
    nav("#/");
  });

  viewSeg.addEventListener("click", (e) => {
    const b = e.target.closest("button[data-view]");
    if(!b) return;
    engView = b.dataset.view;
    renderHome();
  });

  /** Rendering Logic **/
  function renderHome(){
    const ymStr = monthPick.value || curYM();
    const list = filteredList();
    
    listWrap.style.display = (mode === "admin" || engView === "list") ? "block" : "none";
    calendarWrap.style.display = (mode === "eng" && engView === "cal") ? "block" : "none";
    
    if(mode === "eng" && engView === "cal") renderCalendar(list);

    rowsEl.innerHTML = list.length ? "" : `<tr><td colspan="6" class="small">無符合條件資料。</td></tr>`;
    list.forEach(r => {
      rowsEl.insertAdjacentHTML("beforeend", `
        <tr>
          <td><div style="font-weight:800">${esc(r.customer)}</div></td>
          <td>${esc(r.product)}</td>
          <td class="mono">${esc(r.startDate)} ~ ${esc(r.endDate)}</td>
          <td>${renderPlannedMonths(r, ymStr)}</td>
          <td>${renderMonthStatus(r, ymStr)}</td>
          <td>${renderMonthAction(r, ymStr)}</td>
        </tr>
      `);
    });
  }

  function filteredList(){
    const ymStr = monthPick.value || curYM();
    const q = (qEl.value || "").trim().toLowerCase();
    return records.filter(r => {
      if(q && !`${r.customer} ${r.product}`.toLowerCase().includes(q)) return false;
      const sch = findSchedule(r, ymStr);
      if(scope.value === "need" && !sch) return false;
      if(scope.value === "none" && sch) return false;
      if(doneFilter.value === "todo" && (!sch || sch.isDone)) return false;
      if(doneFilter.value === "done" && (!sch || !sch.isDone)) return false;
      return true;
    }).sort((a,b)=> (a.customer||"").localeCompare(b.customer||""));
  }

  /** Render Helpers (Same as before) **/
  function renderPlannedMonths(rec, selectedYM){
    const list = (rec.schedule || []).slice().sort((a,b)=>a.ym.localeCompare(b.ym));
    if(!list.length) return `<span class="small">—</span>`;
    return `<div class="months">` + list.map(s => {
      const cls = s.isDone ? "mchip done" : "mchip todo";
      const selected = (s.ym === selectedYM) ? " selected" : "";
      return `<span class="${cls}${selected}"><span class="d"></span>${esc(s.ym)}</span>`;
    }).join("") + `</div>`;
  }
  function renderMonthStatus(rec, ymStr){
    const sch = findSchedule(rec, ymStr);
    if(!sch) return `<span class="status"><span class="dot neutral"></span>本月無維護</span>`;
    return sch.isDone ? `<span class="status"><span class="dot good"></span>本月已完工</span>` 
                      : `<span class="status"><span class="dot warn"></span>本月未完工</span>`;
  }
  function renderMonthAction(rec, ymStr){
    const sch = findSchedule(rec, ymStr);
    if(!sch) return mode === "admin" ? `<a class="link" href="#/edit?id=${encodeURIComponent(rec.id)}">編輯</a>` : `<span class="small">—</span>`;
    const label = sch.isDone ? "取消完工" : "設定完工";
    const btnClass = sch.isDone ? "btn" : "btn primary";
    const adminLink = (mode === "admin") ? ` <span class="small">｜</span> <a class="link" href="#/edit?id=${encodeURIComponent(rec.id)}">編輯</a>` : "";
    return `<button type="button" class="${btnClass}" style="padding:8px 10px;border-radius:10px" data-act="done" data-id="${esc(rec.id)}" data-ym="${esc(ymStr)}">${esc(label)}</button>${adminLink}`;
  }

  /** Event Listeners (Calling Async Save) **/
  rowsEl.addEventListener("click", async (e) => {
    const btn = e.target.closest("[data-act='done']");
    if(!btn) return;
    const {id, ym} = btn.dataset;
    const rec = records.find(r => r.id === id);
    const sch = findSchedule(rec, ym);

    if(sch.isDone){
      if(!confirm("取消完工？")) return;
      sch.isDone = false; sch.doneDate = "";
      await save(); // 同步雲端
      renderHome();
    } else {
      openDoneModal(id, ym);
    }
  });

  mSave.addEventListener("click", async () => {
    if(!modalCtx) return;
    const rec = records.find(r => r.id === modalCtx.recordId);
    const sch = findSchedule(rec, modalCtx.ym);
    sch.isDone = !!mIsDone.checked;
    sch.doneDate = sch.isDone ? (mDoneDate.value || todayISO()) : "";
    await save(); // 同步雲端
    doneModal.style.display = "none";
    renderHome();
  });

  formEdit.addEventListener("submit", async (e) => {
    e.preventDefault();
    const existing = editingId ? records.find(r => r.id === editingId) : null;
    const keepDone = new Map((existing?.schedule || []).map(s => [s.ym, s]));
    let ymList = Array.from(new Set(editingYMList.filter(Boolean))).sort();
    if(!ymList.length) ymList = buildAutoYMList(startEl.value, endEl.value);
    
    const rec = {
      id: existing?.id || newId(),
      customer: customerEl.value.trim(),
      product: productEl.value.trim(),
      startDate: startEl.value,
      endDate: endEl.value,
      notes: notesEl.value.trim(),
      schedule: normalizeScheduleFromYMList(ymList, keepDone)
    };

    const idx = records.findIndex(r => r.id === rec.id);
    if(idx >= 0) records[idx] = rec; else records.unshift(rec);

    await save(); // 同步雲端
    nav("#/");
  });

  btnDelete.addEventListener("click", async () => {
    if(!confirm("確定刪除？")) return;
    records = records.filter(r => r.id !== editingId);
    await save(); // 同步雲端
    nav("#/");
  });

  btnClear.addEventListener("click", async () => {
    if(!confirm("確定清除全部？")) return;
    records = [];
    await save(); // 同步雲端
    renderHome();
  });

  // 搜尋與篩選同步
  qEl.addEventListener("input", renderHome);
  monthPick.addEventListener("change", renderHome);
  scope.addEventListener("change", renderHome);
  doneFilter.addEventListener("change", renderHome);

  // 初始化：先執行路由，再從雲端抓資料
  router();
  load(); 

  // --- 其他輔助 UI 函數 (openEditor, renderEditorYMChips 等) 保持原樣即可 ---
  function openEditor(id){
    editingId = id;
    if(!id){
      customerEl.value = ""; productEl.value = ""; notesEl.value = "";
      startEl.value = todayISO(); endEl.value = addYearsMinus1Day(startEl.value);
      editingYMList = buildAutoYMList(startEl.value, endEl.value);
    } else {
      const rec = records.find(r => r.id === id);
      customerEl.value = rec.customer; productEl.value = rec.product;
      notesEl.value = rec.notes; startEl.value = rec.startDate; endEl.value = rec.endDate;
      editingYMList = (rec.schedule || []).map(s => s.ym);
    }
    renderEditorYMChips();
  }
  function renderEditorYMChips(){
    const list = Array.from(new Set(editingYMList.filter(Boolean))).sort();
    ymChips.innerHTML = list.map(ym => `<span class="mchip todo">${esc(ym)} <span class="link" data-act="rmYM" data-ym="${esc(ym)}">×</span></span>`).join("");
  }
  ymChips.addEventListener("click", (e) => {
    const rm = e.target.closest("[data-act='rmYM']");
    if(rm){ editingYMList = editingYMList.filter(x => x !== rm.dataset.ym); renderEditorYMChips(); }
  });
  btnAddYM.addEventListener("click", () => { if(addYM.value){ editingYMList.push(addYM.value); renderEditorYMChips(); } });
  btnResetAuto.addEventListener("click", () => { editingYMList = buildAutoYMList(startEl.value, endEl.value); renderEditorYMChips(); });
  btnCancel.addEventListener("click", () => nav("#/"));
  btnBack.addEventListener("click", () => nav("#/"));
  mClose.addEventListener("click", () => doneModal.style.display="none");
  
  // 匯出匯入保留作為備份手段
  btnExport.addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(records, null, 2)], {type:"application/json"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
    a.download = `backup_${todayISO()}.json`; a.click();
  });
})();
</script>
</body>
</html>



